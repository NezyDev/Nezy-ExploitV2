#include <iostream>
#include <Windows.h>
#include <string>
#include <thread>
#include <vector>


int ASLR(uintptr_t address)
{
	return address - 0x400000 + reinterpret_cast<uintptr_t>(GetModuleHandleA(0));
}


uintptr_t exthread;

namespace Addresses
{
	using r_luavm_load_t = uintptr_t(__fastcall*)(uintptr_t rl, std::string* source, const char* chunk, int env);
	r_luavm_load_t r_luavm_load = (r_luavm_load_t)(ASLR(0x72B9F0));


	using r_taskdefer_t = uintptr_t(__cdecl*)(uintptr_t rl);
	r_taskdefer_t r_taskdefer = (r_taskdefer_t)(ASLR(0x7A5480));


	using r_getscheduler_t = uintptr_t(__cdecl*)();
	r_getscheduler_t r_getscheduler = (r_getscheduler_t)(ASLR(0xB502F0));


	using r_print_t = uintptr_t(__cdecl*)(int type, const char* source);
	r_print_t r_lua_print = (r_print_t)(ASLR(0x10358F0));
}


namespace Offsets
{
	const uintptr_t lua_state_top = 20;
	const uintptr_t lua_state_base = 8;
	const uintptr_t lua_state_global = 16;
}


namespace Deobfuscation
{
	uintptr_t luastate(uintptr_t sc)
	{
		return (sc + 276) - *(uintptr_t*)(sc + 276); //u can find it in getstate
	}


	uintptr_t global(uintptr_t rl)
	{
		return (rl + 16) ^ *(uintptr_t*)(rl + 16);
	}
}