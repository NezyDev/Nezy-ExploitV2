#include <iostream>
#include <Windows.h>
#include <string>
#include <thread>
#include <vector>
#include <mutex>

#include "Lua.hpp"
#include "Compressor/include/xxhash.h"
#include "Compressor/include/zstd.h"
#include "Compiler/include/BytecodeBuilder.h"
#include "Compiler/include/Compiler.h"


class bytecode_encoder_t : public Luau::BytecodeEncoder
{
    std::uint8_t encodeOp(const std::uint8_t opcode)
    {
        return opcode * 227;
    }
};


namespace Execution
{
    std::string compress(const std::string& data)
    {
        std::string output = "RSB1";
        std::size_t dataSize = data.size();
        std::size_t maxSize = ZSTD_compressBound(dataSize);
        std::vector<char> compressed(maxSize);
        std::size_t compSize = ZSTD_compress(&compressed[0], maxSize, data.c_str(), dataSize, ZSTD_maxCLevel());
        output.append(reinterpret_cast<char*>(&dataSize), sizeof(dataSize));
        output.append(&compressed[0], compSize);
        std::uint32_t firstHash = XXH32(&output[0], output.size(), 42U);
        std::uint8_t hashedBytes[4];
        std::memcpy(hashedBytes, &firstHash, sizeof(firstHash));
        for (std::size_t i = 0; i < output.size(); ++i)
            output[i] ^= hashedBytes[i % 4] + i * 41U;
        return output;
    }


	void run_script(uintptr_t rl, std::string source)
	{
        bytecode_encoder_t enc;
        std::string bytecode = Luau::compile(source, {}, {}, &enc);
        if (bytecode.at(0) != 0)
        {
            std::string compressed = compress(bytecode);
            Addresses::r_luavm_load(rl, &compressed, "", 0);
            Addresses::r_taskdefer(rl);
            Lua::decrement_top(rl);
        }
        else
        {
            Addresses::r_lua_print(3, bytecode.c_str() + 1);
        }
	}


    void pipe()
    {
        std::string ScriptBuffer;
        char Buffer[999999];
        DWORD ReadWords;
        void* PipeHandle = CreateNamedPipe(TEXT("\\\\.\\pipe\\NezyPipe"), PIPE_ACCESS_DUPLEX | PIPE_TYPE_BYTE | PIPE_READMODE_BYTE, PIPE_WAIT, 1, 999999, 999999, NMPWAIT_USE_DEFAULT_WAIT, 0);
        while (true)
        {
            if (ConnectNamedPipe(PipeHandle, 0))
            {
                while (ReadFile(PipeHandle, Buffer, sizeof(Buffer) - 1, &ReadWords, 0))
                {
                    Buffer[ReadWords] = '\0';
                    ScriptBuffer.append(Buffer);
                }

                run_script(exthread, ScriptBuffer);
                ScriptBuffer.clear();
            }
            DisconnectNamedPipe(PipeHandle);
        }
    }
}