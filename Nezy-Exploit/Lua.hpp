#include <iostream>
#include <Windows.h>
#include <string>
#include <thread>
#include <vector>
#include <mutex>

#include "LuaState.hpp"
#include "Tools.hpp"


namespace Lua
{
	void decrement_top(uintptr_t rl)
	{
		*(uintptr_t*)(rl + Offsets::lua_state_top) -= 16;
	}


	void increment_top(uintptr_t rl)
	{
		*(uintptr_t*)(rl + Offsets::lua_state_top) += 16;
	}


	void setlevel(uintptr_t rl, int8_t identity)
	{
		*(int8_t*)(*(uintptr_t*)(rl + 72) + 24) = identity;
	}


    int r_luam_newgco(uintptr_t rl, size_t nsize, uint8_t memcat)
    {
        auto global = Deobfuscation::global(rl);
        auto frealloc = *reinterpret_cast<uintptr_t(__cdecl**)(uintptr_t, uintptr_t, uintptr_t, size_t)>(global + 12);
        auto block = frealloc(*reinterpret_cast<uintptr_t*>(global + 16), 0, 0, nsize);
        *reinterpret_cast<uintptr_t*>(global + 40) += nsize; //40 totalbytes
        *reinterpret_cast<uintptr_t*>(global + 4 * memcat + 320) += nsize; //320 memcatbytes
        return block;
    }
}
